# ArtSlave 工作流模块设置指南

## 🎯 功能概述

ArtSlave 工作流模块集成了 n8n 自动化平台，提供以下功能：

- **信息投递自动化**: 自动匹配用户与投稿信息，发送个性化推荐
- **数据同步工作流**: 定期同步和统计投稿数据
- **实时监控面板**: 监控工作流执行状态和性能
- **API 集成**: 与 ArtSlave 数据库无缝集成

## 🚀 快速开始

### 1. 环境准备

确保已安装依赖：
```bash
cd artslave
npm install
```

### 2. 配置工作流环境

运行设置脚本：
```bash
npm run workflow:setup
```

### 3. 启动 n8n 服务

```bash
# 标准模式
npm run n8n:start

# 开发模式 (详细日志)
npm run n8n:dev
```

### 4. 访问工作流管理

- **n8n 编辑器**: http://localhost:5678
- **ArtSlave 工作流管理**: http://localhost:3000/workflow

## 📋 工作流配置

### 导入预设工作流

1. 访问 n8n 界面: http://localhost:5678
2. 点击右上角的 "Import from File"
3. 导入以下工作流文件：
   - `n8n/workflows/artslave-data-sync.json` - 数据同步工作流
   - `n8n/workflows/submission-automation.json` - 投递自动化工作流

### 激活工作流

1. 在 n8n 中打开导入的工作流
2. 检查所有节点配置
3. 点击右上角的 "Active" 开关激活工作流

## 🔧 API 端点

工作流模块提供以下 API 端点：

### 状态监控
- `GET /api/workflow/status` - 检查 n8n 连接状态
- `GET /api/workflow/monitor` - 获取执行监控数据

### 工作流管理
- `GET /api/workflow/list` - 获取工作流列表
- `POST /api/workflow/execute/{id}` - 执行指定工作流

### 数据访问
- `GET /api/workflow/data/submissions` - 获取投稿信息
- `GET /api/workflow/data/users` - 获取用户数据
- `GET /api/workflow/data/stats` - 获取统计数据

## 🎛️ 工作流管理界面

访问 `/workflow` 页面可以：

- 查看工作流运行状态
- 监控执行记录和性能
- 手动触发工作流执行
- 查看实时统计数据
- 管理 n8n 连接

### 主要功能

1. **实时监控面板**
   - 运行中的工作流数量
   - 成功/失败执行统计
   - 平均执行时间

2. **执行记录**
   - 最近执行历史
   - 执行状态和耗时
   - 错误信息查看

3. **快速操作**
   - 一键打开 n8n 编辑器
   - 执行数据同步
   - 触发自动投稿流程

## 🔄 工作流详解

### 1. 数据同步工作流 (artslave-data-sync)

**功能**: 定期同步投稿信息，生成统计报告

**流程**:
1. 获取投稿数据 → 2. 检查响应 → 3. 处理数据 → 4. 获取数据库统计 → 5. 合并统计数据 → 6. 记录结果

**触发方式**: 手动触发或定时执行

### 2. 投递自动化工作流 (submission-automation)

**功能**: AI 匹配用户与投稿信息，自动发送推荐

**流程**:
1. 获取活跃投稿 → 2. 分割处理 → 3. 获取用户列表 → 4. AI 匹配算法 → 5. 筛选高匹配度 → 6. 保存结果 → 7. 发送通知

**匹配算法**:
- 用户类型匹配 (30%)
- 地理位置匹配 (20%)
- 艺术领域匹配 (30%)
- 经验水平匹配 (20%)

## 🛠️ 故障排除

### n8n 无法启动

**问题**: 端口被占用
```bash
# 检查端口占用
netstat -an | grep 5678
# 或使用其他端口
N8N_PORT=5679 npm run n8n:start
```

**问题**: 权限错误
```bash
# 确保目录权限
chmod -R 755 n8n/
```

### 工作流执行失败

1. **检查 API 连接**
   - 确保 ArtSlave 应用正在运行 (localhost:3000)
   - 检查数据库连接

2. **查看执行日志**
   - 在 n8n 界面中查看执行详情
   - 检查错误节点的输出

3. **验证数据格式**
   - 确保 API 返回正确的数据格式
   - 检查必需字段是否存在

### 数据同步问题

1. **数据库连接**
   ```bash
   # 检查数据库文件
   ls -la prisma/dev.db
   
   # 重新生成 Prisma 客户端
   npx prisma generate
   ```

2. **API 权限**
   - 确保 API 端点可访问
   - 检查 CORS 配置

## 📈 性能优化

### 1. 执行频率控制
- 避免过于频繁的自动执行
- 使用合适的批处理大小

### 2. 数据库优化
- 定期清理执行历史
- 优化查询性能

### 3. 监控告警
- 设置执行失败告警
- 监控资源使用情况

## 🔐 安全考虑

1. **API 访问控制**
   - 限制工作流 API 访问
   - 使用适当的认证机制

2. **数据保护**
   - 敏感数据加密存储
   - 限制数据访问范围

3. **网络安全**
   - 配置防火墙规则
   - 使用 HTTPS (生产环境)

## 📞 支持

如遇问题，请：

1. 查看 n8n 日志: `n8n/logs/`
2. 检查 ArtSlave 应用日志
3. 访问工作流管理页面查看状态
4. 参考 n8n 官方文档: https://docs.n8n.io/

---

**提示**: 首次使用建议先在开发环境中测试所有工作流，确认正常后再部署到生产环境。
